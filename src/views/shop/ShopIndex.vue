<template>
    <section id="banner" style="background: #F9F3EC;">
        <div class="container">
            <div class="swiper main-swiper">
                <div class="swiper-wrapper">
                    <div v-for="(slide, index) in slides" :key="index" class="swiper-slide py-5">
                        <div class="row banner-content align-items-center">
                            <div class="img-wrapper col-md-5">
                                <img :src="slide.img" class="img-fluid" alt="banner-image">
                            </div>
                            <div class="content-wrapper col-md-7 p-5 mb-5">
                                <div class="secondary-font display-6 text-uppercase mb-4 fw-bold"
                                    style="color: #7B3F00;">
                                    {{ slide.subtitle }}
                                </div>

                                <h1 class="banner-title  display-3 fw-normal">{{ slide.title }}</h1>
                                <h1>ÊÇ®ÁöÑÊúÄ‰Ω≥ÈÅ∏Êìá!</h1>

                                <div class="d-flex">
                                    <router-link :to="`/shop/productDetail?productDetailId=${slide.productDetailId}`"
                                        class="btn btn-outline-dark btn-lg text-uppercase fs-6 rounded-1 me-4 mt-4">
                                        Êü•ÁúãË©≥ÊÉÖ
                                        <svg width="24" height="24" viewBox="0 0 24 24" class="mb-1">
                                            <use xlink:href="#arrow-right"></use>
                                        </svg>
                                    </router-link>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ÂàÜÈ†ÅÊåáÁ§∫Âô® -->
                <div class="swiper-pagination mb-5"></div>
            </div>
        </div>
    </section>

    <section id="products" class="container my-5">

        <div v-if="searchProductKeyword">
            <h2 class="mb-3">
                <span>'</span>
                <span style="color: crimson;">{{ searchProductKeyword ? searchProductKeyword : "" }}</span>
                <span>' ÊêúÂ∞ãÁµêÊûú</span>
            </h2>
        </div>

        <!-- ÂïÜÂ∫óÊ®ôÈ°å -->
        <div class="section-header d-md-flex justify-content-between align-items-center">
            <h2 class="display-3 fw-normal">ÂïÜÂìÅ</h2>
        </div>

        <!-- ÂïÜÂìÅÂÖßÂÆπ -->
        <div class="container row">
            <!-- ÂïÜÂìÅCard -->
            <div class="col-md-4 col-lg-3 my-4" v-if="productDetailDtoList"
                v-for="productDetailDto in productDetailDtoList" :key="productDetailDto.productDetail.id">
                <!-- ÂïÜÂìÅÂ∑¶‰∏äÂ≠óÊ®£ -->
                <!-- <div class="z-1 position-absolute rounded-3 m-3 px-3 border border-dark-subtle">
                        New
                </div> -->
                <div class="card position-relative">
                    <!-- ÂïÜÂìÅÂúñÁâá -->
                    <div>
                        <img :src="`${PATH}/shop/products/api/getPhoto?productDetailId=${productDetailDto.productDetail.id}`"
                            alt="image" class="img-fluid rounded-4" style="height: 180px;">
                    </div>
                    <div class="card-body p-0">
                        <!-- ÂïÜÂìÅÂêçÁ®± -->
                        <h3 class="card-title pt-4 m-0" style="font-size: 1.2em;">{{ productDetailDto.productDetail.name
                        }}</h3>
                        <div class="card-text">
                            <!-- ÂïÜÂìÅË©ïÂÉπ ÊòüÊòü -->

                            <span class="rating secondary-font">
                                <span class="star-rating">
                                    <i v-for="star in 5" :key="star" :class="['fa', {
                                        'fa-star fas text-primary': star <= (productDetailDto.avgRating || 0),
                                        'fa-star far text-secondary': star > (productDetailDto.avgRating || 0)
                                    }]">
                                    </i>
                                </span>
                                ({{ (productDetailDto.avgRating || 0).toFixed(1) }})
                            </span>


                            <!-- ÂïÜÂìÅÂÉπÈå¢ -->
                            <h3 class="secondary-font text-primary" style="font-size: 1.2em;">$ {{
                                productDetailDto.minPriceProduct.discountPrice
                                    ? productDetailDto.minPriceProduct.discountPrice :
                                    productDetailDto.minPriceProduct.unitPrice }}
                                <span>&nbsp;</span>
                                <span v-if="productDetailDto.minPriceProduct.discountPrice" class="discount-tag">
                                    {{ (10 * productDetailDto.minPriceProduct.discountPrice /
                                        productDetailDto.minPriceProduct.unitPrice).toFixed(1) }}Êäò
                                </span>
                            </h3>

                            <!-- Êü•ÁúãË©≥ÊÉÖ -->
                            <div class="d-flex flex-wrap mt-3 detail-button-container">
                                <!-- Ë©≥ÊÉÖÊåâÈàï -->
                                <RouterLink
                                    :to="{ path: '/shop/productDetail', query: { productDetailId: productDetailDto.productDetail.id } }">
                                    <div class="detail-button btn btn-light btn-sm me-3 px-4 pt-3 pb-3">
                                        ÁúãË©≥ÊÉÖ
                                    </div>
                                </RouterLink>
                                <!-- ÊÑõÂøÉÊåâÈàï -->
                                <!-- <a href="#" class="btn-wishlist px-4 pt-3 ">
                                        <iconify-icon icon="fluent:heart-28-filled" class="fs-5"></iconify-icon>
                                </a> -->
                            </div>


                        </div>

                    </div>
                </div>
            </div>
            <div v-else>
                <h2>Êü•ÁÑ°ÂÖßÂÆπ</h2>
            </div>
        </div>

        <!-- ÂàÜÈ†Å -->
        <div class="container" v-if="total > 0">
            <Paginate v-model="currentPage" :page-count="pages" :initial-page="currentPage" :page-range="3"
                :margin-pages="1" :click-handler="onChangePage" :first-last-button="true"
                prev-text="<i class= 'bi bi-chevron-left' > </i>" next-text="<i class= 'bi bi-chevron-right' > </i>"
                first-button-text="<i class= 'bi bi-chevron-bar-left' > </i>"
                last-button-text="<i class= 'bi bi-chevron-bar-right' > </i>">

            </Paginate>
        </div>

    </section>
</template>

<script setup>
import { ref, onMounted, watch, nextTick } from 'vue';
import { useRoute } from "vue-router";
import Paginate from 'vuejs-paginate-next';
import axios from 'axios';
import Swiper from 'swiper';
import { Autoplay, Pagination, Navigation } from 'swiper/modules';
import 'swiper/css';
import 'swiper/css/pagination';
import 'swiper/css/navigation';

const slides = ref([
    {
        img: '/user_static/images/item13.jpg',
        subtitle: 'üîîÊúÄÊñ∞‰∏äÊû∂',
        title: 'ÂØµÁâ©Êô∫ËÉΩÈ§µÈ£üÂô®',
        productDetailId: 19, // ÊúÄÊñ∞‰∏äÊû∂
    },
    {
        img: '/user_static/images/banner-img4.png',
        subtitle: 'üî•ÊúÄÁÜ±Èä∑',
        title: 'ÂØµÁâ©Â≠∏Èô¢È¢®ÈáùÁπîËÉåÂøÉ',
        productDetailId: 1, // ÊúÄÁÜ±Èä∑>>ÂØµÁâ©ÈáùÁπîË°£
    },
    {
        img: '/user_static/images/banner-img.png',
        subtitle: 'üåüÊúÄÂñúÊÑõ',
        title: 'Ë≤ìÂí™Ê£âÁπ©Áé©ÂÖ∑ÁêÉ',
        productDetailId: 2, // ÊúÄÂñúÊÑõ>>ÂØµÁâ©Áé©ÂÖ∑ÁêÉ
    }
]);
onMounted(async () => {
    await nextTick();

    setTimeout(() => {
        const swiper = new Swiper('.main-swiper', {
            modules: [Autoplay, Pagination, Navigation],
            loop: true,
            autoplay: {
                delay: 3000,
                disableOnInteraction: false,
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
                dynamicBullets: true,
            },
        });

        swiper.update();
    }, 100);
});

const route = useRoute();

const PATH = `${import.meta.env.VITE_API_URL}`;

// ÂàùÂßãËºâÂÖ•
const productDetailDtoList = ref([]);

// ÂïÜÂìÅÂàÜÈ°û
const selectedCategory = ref(route.query.category || "ÊâÄÊúâÂïÜÂìÅ");   // È†êË®≠Âæû query ËÆÄÂèñ
// ÈóúÈçµÂ≠óÊêúÂ∞ã
const searchProductKeyword = ref(route.query.keyword || "");

// ÂàÜÈ†Å
const currentPage = ref(1); // ÁõÆÂâçÂú®Á¨¨ÂπæÈ†Å
const pages = ref(0);   // Á∏ΩÂÖ±ÊúâÂπæÈ†Å
const total = ref(0);   // Á∏ΩÂÖ±ÊúâÂπæÁ≠Ü
const rows = ref(12);   // ÊØèÈ†ÅÈ°ØÁ§∫ÂπæÁ≠Ü
const start = ref(0);   // ÂæûÁ¨¨ÂπæÁ≠ÜË≥áÊñôÈñãÂßã
const lastPageRows = ref(0); // ÊúÄÂæå‰∏ÄÈ†ÅÊúâÂπæÁ≠Ü

onMounted(async () => {
    onChangePage();
})

// #region Event function =================================================

// ÂàÜÈ†ÅÂàáÊèõ
function onChangePage(page) {
    if (page) {
        currentPage.value = page;
        start.value = (page - 1) * rows.value;
    } else {
        currentPage.value = 1;
        start.value = 0;
    }

    const data = {
        "start": start.value,
        "rows": rows.value,
        "category": selectedCategory.value,
        "keyword": searchProductKeyword.value ? searchProductKeyword.value : null
    }

    getProducts(data);

}

// #endregion =================================================


// Âä†ËºâÂïÜÂìÅ
async function getProducts(data) {
    await axios({
        method: 'get',
        url: `${PATH}/shop/products`,
        params: data
    })
        .then(response => {
            console.log(response.data);
            productDetailDtoList.value = response.data.productDetailDtoList;

            // ÂàÜÈ†Å
            total.value = response.data.count;
            pages.value = Math.ceil(total.value / rows.value);
            lastPageRows.value = total.value % rows.value;
        })

        .catch(error => console.log(error));
}

// Áõ£ËÅΩqueryËÆäÂåñ
watch(() => route.query, async () => {
    selectedCategory.value = route.query.category || "ÊâÄÊúâÂïÜÂìÅ";
    searchProductKeyword.value = route.query.keyword || "";
    onChangePage();

}, { deep: true });


</script>

<style scoped>
/* cardÊ®£Âºè */
.card {
    width: 250px;
    min-height: 400px;
    background-color: #fffcf6;
    border-radius: 10px;
    position: relative;
    padding-bottom: 60px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
}

/* ÂúñÁâáÂõ∫ÂÆöÂ§ßÂ∞è */
.card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
}

/* ËÆì card-body Âç†ÊªøÂèØÁî®Á©∫ÈñìÔºåÊé®ÂãïÊåâÈàïÂà∞Â∫ïÈÉ® */
.card-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding-bottom: 50px;
}

.card-title {
    font-size: 1.5em;
}

.card-text {
    flex-grow: 1;
    margin-bottom: 10px;
}

/* Á¢∫‰øù RouterLink ‰πü‰ΩîÊªø */
.detail-button-container {
    width: 100% !important;
    display: flex !important;
    justify-content: center !important;
}

/* ËÆìÊåâÈàïÂõ∫ÂÆöÂú® Card Â∫ïÈÉ®‰∏¶‰ΩîÊªøÂØ¨Â∫¶ */
.detail-button {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    /* Á¢∫‰øùÂÆåÂÖ®‰ΩîÊªø */
    text-align: center;
    padding: 15px 0;
    font-size: 1.2em;
    border-radius: 0 0 15px 15px;
    /* ËÆìÊåâÈàïËàá Card ÁöÑÂúìËßí‰∏ÄËá¥ */
    transition: 0.3s;
    background-color: #F4D8B1 !important;
    /* ÊåâÈàïËÉåÊôØËâ≤ */
}

.detail-button:hover {
    background-color: #e9ca94 !important;
    color: #000;
}

/* ÊâìÊäòÂ≠óÈ´îÊ®£Âºè */
.discount-tag {
    background-color: #ffecec;
    color: #d7000f;
    font-size: 0.6em;
    padding: 2px 4px;
    border-radius: 3px;
    display: inline-block;
    min-width: 30px;
    text-align: center;
}

.star-rating i.fas {
    padding-top: 5px;
    color: #f8c307 !important;
    font-size: 1rem;
}

.star-rating i.far {
    padding-top: 5px;
    color: #ddd;
    font-size: 1rem;
}

#banner .swiper {
    max-height: 500px;
    overflow: hidden;

}

#banner .swiper-slide img {
    max-width: 80%;
    max-height: 400px;
    object-fit: contain;
}

#banner .container {
    padding-left: 75px;
    padding-right: 75px;
}
</style>